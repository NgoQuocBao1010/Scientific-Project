{% extends 'accounts/main.html' %} {% load static %} {% block content %}
<style>
    table tbody {
        display: block;
        max-height: 30vh;
        overflow-y: scroll;
    }

    table thead,
    table tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
</style>

<div class="container">
    <div class="container">
        <h1>{{ pi }}</h1>
        <hr>

        <div class="info">
            {% if pi.status == 'online' %}
            <h2>Status: <span style="color: lightgreen;">Ongoing</span></h2>
            <h3>StartTime: {{ onDrive.startTime }}</h3>

            {% else %}

            <h2>Status: <span style="color: gray;">Ended</span></h2>
            {% endif %}
        </div>
        <hr>
        <div class="historyTable">
            <h3>All previous Drives</h3>
            <div>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Driver</th>
                            <th scope="col">Time Start</th>
                            <th scope="col">Time Ended</th>
                        </tr>
                    </thead>
                    <tbody id="myTable">
                        {% for drive in previousDrives %}
                        <tr>
                            <td>{{ drive.device.car.driver }}</td>
                            <td>{{ drive.startTime }}</td>
                            <td>{{ drive.endTime }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>


</div>
<script>


</script>

<script>
    var piDevice = {};
    piDevice.id = '{{ pi.id }}';
    piDevice.name = '{{ pi.name }}';
    piDevice.status = '{{ pi.status }}';

    var onDrive = {};

    if (piDevice.status == 'online') {
        onDrive.startTime = '{{ onDrive.startTime }}';
    }

    var info = document.querySelector('.info');


    let socket = new WebSocket("ws://localhost:8000/ws/realtime/");

    socket.onopen = function (e) {
        alert("Connection established");
    };

    socket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        console.log(data);

        if (typeof data['dis'] !== 'undefined') {
            var offlineDevices = data['dis'];

            for (offDevice of offlineDevices) {
                if (offDevice === piDevice.name) {
                    piDevice.status = 'offline';
                    onDrive.endTime = data['disTime'];

                    info.innerHTML = '';
                    var h2 = document.createElement('h2');
                    h2.innerHTML = "Status: ";
                    var span = document.createElement('span');
                    span.innerHTML = 'Ended';
                    span.style.color = 'gray';
                    h2.appendChild(span);
                    info.appendChild(h2);

                    var myTableBody = document.getElementById('myTable');
                    tr = myTableBody.insertRow(0);
                    tr.style.backgroundColor = 'lightblue';

                    var td = document.createElement('td');
                    td.innerHTML = "Driver Vinh Mai";
                    tr.appendChild(td);
                    var td = document.createElement('td');
                    td.innerHTML = onDrive.startTime;
                    tr.appendChild(td);
                    var td = document.createElement('td');
                    td.innerHTML = onDrive.endTime;
                    tr.appendChild(td);
                }
            }
        }

        if (typeof data['time'] !== 'undefined') {
            if (piDevice.name === data['name']) {
                if (piDevice.status === 'offline') {
                    piDevice.status = 'online';
                    onDrive.startTime = data['time'];

                    info.innerHTML = '';
                    var h2 = document.createElement('h2');
                    h2.innerHTML = "Status: ";
                    var span = document.createElement('span');
                    span.innerHTML = 'Ongoing';
                    span.style.color = 'lightgreen';
                    var h3 = document.createElement('h3');
                    h3.innerHTML = "StartTime: " + data['time'];
                    h2.appendChild(span);
                    info.appendChild(h2);
                    info.appendChild(h3);
                }
            }
        }
    };

    socket.onclose = function (e) {
        alert("Connection closed");
    };
</script>
{% endblock %}